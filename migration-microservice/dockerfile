# Use the official Jupyter Docker image with Notebook 6.5.4
FROM jupyter/base-notebook:notebook-6.5.4

# Switch to root to install wget and other utilities
USER root

# Install necessary dependencies
RUN apt-get update && apt-get install -y wget

# Install required Python packages
RUN pip install ipywidgets fastapi uvicorn nbformat openai psycopg2-binary && \
    jupyter nbextension enable --py widgetsnbextension --sys-prefix
RUN pip install --no-cache-dir pandas scikit-learn matplotlib

# Create required directories
RUN mkdir -p /home/jovyan/work /home/jovyan/.jupyter/custom

# Copy custom JavaScript for Jupyter
COPY custom.js /home/jovyan/.jupyter/custom/custom.js
RUN chown -R $NB_UID:$NB_UID /home/jovyan/.jupyter/custom

# Copy the Fast API script
COPY notebook_api.py /home/jovyan/notebook_api.py

# Copy the start script and set permissions
COPY start.sh /usr/local/bin/start.sh
RUN chmod +x /usr/local/bin/start.sh

# Switch back to the non-root user (jovyan)
USER $NB_UID

# Expose ports for Jupyter (8888) and Fast API (5000)
EXPOSE 8888 5000

ENV PYTHONUNBUFFERED=1

# Start both JupyterLab and Fast API
CMD ["/usr/local/bin/start.sh"]